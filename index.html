<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Recipes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- <script src="https://cdn.jsdelivr.net/npm/marked@16.4.1/lib/marked.umd.min.js"></script> -->
<script src="js/marked-16.4.1-marked.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css?family=Fira+Sans:400,400i,700,700i,900" rel="stylesheet">

<style>
:root {
  font-family: 'Fira Sans', sans-serif;
}
body {
  background: #f8f8f8;
}
a {
  color: #06c;
}

#filter-search {
  padding: 5px;
  border-radius: 5px;
  border: 1px solid #ddd;
}
#filter-category {
  padding: 5px;
  border-radius: 5px;
  border: 1px solid #ddd;
}
#filter-tags {
  /* display: flex; */
}
#filter-tags .tag-container {
  /* display: flex; */
  /* align-items: center; */
  display: inline-block;
  margin: 2px 2px 2px 0;
}
#filter-tags input[type=checkbox] {
  display: none;
}
#filter-tags :checked + .tag-text {
  font-weight: bold;
}
.tag-text {
  padding: 2px 8px;
  margin: 0 3px;
  background: #eee;
  border-radius: 5px;
  display: inline-block;
  font-size: 14px;
}

.category {
  /* padding: 5px;
  margin: 5px; */
}
.tag {
  padding: 2px 8px;
  margin: 0 3px;
  background: #e8e8e8;
  border-radius: 5px;
  display: inline-block;
  font-size: 14px;
}
.label {
  /* font-weight: bold; */
}
.recipe h2 {
  text-transform: uppercase;
  margin: 10px 0;
  font-size: 1.4em;
}
.recipe h3 {
  margin: 5px 0;
  font-size: 1em;
}
.ingredients {
}
.ingredients ul {
  list-style: none;
  padding-left: 0px;
  margin: 0;
}
.ingredients li {
}
.ingredient-name {
  font-style: italic;
}
.ingredient-note {
  font-style: italic;
  color: #888;
}
.ingredient-quantity {
  font-size: 14px;
  background: #e8e8e8;
  border-radius: 3px;
  padding: 0px 5px;
  margin-right: 5px;
}
.-ingr- {
  background: #eee;
  font-style: italic;
  font-weight: bold;
}

.instructions ul,
.instructions ol {
  padding-left: 18px;
}
.instructions p {
  padding-left: 0px;
}
.instructions .selected {
  background: #ffb;
}


.recipe code {
  font-size: 14px;
  background: #e8e8e8;
  border-radius: 3px;
  padding: 0px 5px;
  margin: 0 5px;
}
.recipe blockquote {
  border-left: 3px solid #ccc;
  margin-left: 10px;
  padding-left: 10px;
}
</style>
</head>

<body>
<div id="root">
  <div id="filter-controls">
    <input type="search" id="filter-search" placeholder="Search...">
    <select id="filter-category">
      <option value="">-</option>
    </select>
    <a href="#">clear</a>
    <div id="filter-tags">
      <!-- <label><input type="checkbox" value="tag-1">tag-1</label> -->
    </div>
  </div>
  <div id="main"></div>
  <!--
  <div id="recipes-list"></div>
  <div id="recipe-details"></div>
  -->
</div>


<script>
window.onload = async function () {
  const $searchInput = document.getElementById('filter-search')
  const $categorySelect = document.getElementById('filter-category')
  const $tagsContainer = document.getElementById('filter-tags')
  const $tagCheckboxes = []
  // const $recipesList = document.getElementById('recipes-list')
  // const $recipeDetails = document.getElementById('recipe-details')
  const $mainContainer = document.getElementById('main')


  const recipes = await fetch('recipes.json?cache='+Math.random()).then((res) => res.json())
  recipes.forEach((r) => {
    if (typeof r.tags === 'string') r.tags = r.tags.split(/\s*,\s*/)
  })
  console.log('recipes:', recipes)



  const categories = [...new Set(recipes.map(rec => rec.category))]
  console.log('categories:', categories)
  const tags = [...new Set(recipes.flatMap(rec => rec.tags))]
  console.log('tags:', tags)

  categories.forEach(cat => {
    $categorySelect.add(new Option(cat, cat))
  })
  tags.forEach(tag => {
    const tagId = `tag_${tag.replaceAll('-', '_')}`
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = tagId; // Unique ID for each checkbox
    checkbox.name = 'tags'; // Common name for grouping
    checkbox.className = 'tag';
    checkbox.value = tag;
    $tagCheckboxes.push(checkbox);

    const tagLabel = document.createElement('span')
    tagLabel.innerText = tag
    tagLabel.className = 'tag-text'

    const label = document.createElement('label');
    label.className = 'tag-container'
    label.appendChild(checkbox);
    // label.appendChild(document.createTextNode(tag));
    label.appendChild(tagLabel);

    $tagsContainer.appendChild(label);
  });

  [$categorySelect, ...$tagCheckboxes].forEach(el => el.addEventListener('input', updateUrlFiltersParams));
  // when search is empty (useful for when search is cleared)
  $searchInput.addEventListener('input', () => {
    if ($searchInput.value === '') updateUrlFiltersParams()
  })
  // when enter pressed in search box (to prevent too many updates while typing)
  $searchInput.addEventListener('keydown', () => {
    if (event.key === 'Enter') updateUrlFiltersParams()
  })

  function updateUrlFiltersParams() {
    const q = $searchInput.value.toLowerCase();
    const category = $categorySelect.value;
    const tags = Array.from($tagCheckboxes)
      .filter(c => c.checked)
      .map(c => c.value);
    console.log('update url filter to :', {q, category, tags})

    const filterQueryString = new URLSearchParams()
    if (q) filterQueryString.append('q', q)
    if (category) filterQueryString.append('category', category)
    if (tags.length) filterQueryString.append('tags', tags.join(','))
    console.log('filterQueryString:', filterQueryString)
    window.location.hash = `#/?${filterQueryString}`
  }



  window.addEventListener('hashchange', handleHashChange);
  handleHashChange();
  function handleHashChange() {
    // parse hash url
    const hash = window.location.hash.replace(/^#/, '');
    const urlParts = new URL(hash, 'https://example.com')
    // console.log('route:', urlParts)
    console.log('route:', urlParts.pathname + urlParts.search)

    if (urlParts.pathname === '/') {
      // set filter params from url
      $searchInput.value = urlParts.searchParams.get('q') ?? ''
      $categorySelect.value = urlParts.searchParams.get('category') ?? ''
      const queryTags = (urlParts.searchParams.get('tags') ?? '').split(',')
      $tagCheckboxes.forEach(tagCheckbox => {
        tagCheckbox.checked = queryTags.includes(tagCheckbox.value)
      })
      filterRecipes()
    } else if (urlParts.pathname.match(/^\/recipes\/(.+)$/)) {
      const [, recipeId] = urlParts.pathname.match(/^\/recipes\/(.+)$/)
      const recipe = recipes.find(rec => rec.file.replace(/\.(.+?)$/, '') === recipeId)
      if (!recipe) {
        console.log(`recipe ${recipeId} not found`)
        renderNotFound()
        return
      }
      renderRecipe(recipe)
    } else {
      renderNotFound()
    }
  }



  function filterRecipes() {
    const q = $searchInput.value.toLowerCase();
    const category = $categorySelect.value;
    const tags = $tagCheckboxes
      .filter(c => c.checked)
      .map(c => c.value);
    console.log('filter:', {q, category, tags})

    const searchTokens = q
      ? q.match(/"([^"]*)"|'([^']*)'|(\S+)/g).map(tok => tok.replaceAll('"', '').replaceAll('\'', ''))
      : []
    const filtered = recipes.filter(rec => {
      // if (q && !rec.contentRaw.toLowerCase().includes(q)) return false
      if (searchTokens.length && !searchTokens.every(tok => JSON.stringify(rec).toLowerCase().includes(tok))) return false
      if (category && rec.category !== category) return false
      if (tags.length > 0 && !tags.every(t => rec.tags.includes(t))) return false
      return true
    });
    console.log('filtered:', filtered)
    renderRecipes(filtered)
  }
  function renderRecipes(recipes) {
    document.title = 'Recipes'
    // $recipeDetails.style.display = 'none'
    // $recipesList.style.display = 'block'
    $mainContainer.innerHTML = recipes.map(rec => {
      const recipeId = rec.file.replace(/\.(.+?)$/, '')
      return `
        <div class="recipe-summary">
          <h4><a href="#/recipes/${recipeId}">${rec.name}</a></h4>
          <span class="category">${rec.category}</span>
          <span>${rec.tags?.map(tag => `<span class="tag-text">${tag}</span>`).join('')}</span>
          <a style="font-size: 12px;" href="https://github.com/paganwinter/recipe-book/blob/main/recipes/${rec.file}">${rec.file}</a>
        </div>
      `
    }).join('')
  }



  function parseIngredient(i) {
    const [ingredient, quantity] = i.split(/\s*@\s*/)
    const ingrNote = ingredient.match(/^(.+?)\s*\(([^)]+)\)$/)
    if (ingrNote) {
      return {
        name: ingrNote[1],
        note: ingrNote[2],
        quantity,
      }
    }
    return { name: ingredient, quantity }
  }
  async function renderRecipe(rec) {
    marked.use({
      async: false,
      pedantic: false,
      gfm: true,
    })

    console.log('displaying recipe', rec)

    document.title = rec.name
    // $recipesList.style.display = 'none'
    // $recipeDetails.style.display = 'block'

    const ingredientNames = []
    const ingredients = {}
    Object.entries(rec.ingredients).forEach(([group, items]) => {
      ingredients[group] = {
        group,
        items: [],
      }
      items.forEach(i => {
        if (typeof i !== 'object') {
          const {name, note, quantity} = parseIngredient(`${i}`)
          ingredients[group].items.push({name, note, quantity})
          name.split(/\s+/).forEach(p => {
            if (!ingredientNames.includes(p)) ingredientNames.push(p)
          })
          return
        }

        const [nestedGroup, nestedItems] = Object.entries(i)[0]
        ingredients[nestedGroup] = {
          group: nestedGroup,
          items: []
        }
        nestedItems.forEach(ni => {
          const {name, note, quantity} = parseIngredient(`${ni}`)
          ingredients[nestedGroup].items.push({name, note, quantity})
          name.split(/\s+/).forEach(p => {
            if (!ingredientNames.includes(p)) ingredientNames.push(p)
          })
        })
      })
    })
    console.log('ingredients:', ingredients)
    console.log('ingredientNames:', ingredientNames)

    let instructions = rec.instructions.replace(/\s*\|/, '')
    ingredientNames.forEach(i => {
      // instructions = instructions.replaceAll(new RegExp(`\\W${i}\\W`, 'gi'), ` <span class="-ingr-">${i}</span> `)
      instructions = instructions.replaceAll(new RegExp(`(\\W)(${i})(\\W)`, 'gi'), `$1***$2***$3`)
    })
    console.log({instructions})
    const note = rec.note ?? rec.notes

    $mainContainer.innerHTML = `
      <div class="recipe">
        <h1 class="title">${rec.name}</h1>
        <section class="info">
          <a style="font-size: 12px;" href="https://github.com/paganwinter/recipe-book/blob/main/recipes/${rec.file}">${rec.file}</a>
          <div>
            <span class="category">${rec.category}</span>
            <span class="tags">${rec.tags?.map(tag => `<span class="tag">${tag}</span>`).join('')}</span>
          </div>
          <div>
            ${rec.prep_time && `<span class="prep-time"><span class="label">prep:</span> ${rec.prep_time}</span> | ` || ''}
            ${rec.cook_time && `<span class="cook-time"><span class="label">cook:</span> ${rec.cook_time}</span> | ` || ''}
            ${rec.serves && `<span class="serves"><span class="label">serves:</span> ${rec.serves}</span>` || ''}
          </div>
          ${rec.desc && `<div class="description">${marked.parse(rec.desc)}</div>` || '' }
          ${note && `<div class="note">${marked.parse(note)}</div>` || '' }
        </section>
        <hr />
        <section class="ingredients">
          <h2>Ingredients</h2>
          ${Object.values(ingredients).map(({ group, items }) => {
            return `
              <div class="ingredient-group">
                <h3>${group}</h3>
                <ul>
                  ${items.map(i => {
                    return `
                      <li>
                        <label>
                          <input type="checkbox" /><span class="ingredient-name">${i.name}</span>
                          ${i.note ? `<span class="ingredient-note">(${i.note})</span>` : ''}
                          ${i.quantity ? `<span class="ingredient-quantity">${i.quantity}</span>` : ''}
                        </label>
                      </li>`
                    }).join('')
                  }
                </ul>
              </div>
            `
          }).join('')}
        </section>
        <hr />
        <section class="instructions">
          <h2>Instructions</h2>
          <div>${marked.parse(instructions)}</div>
        </section>
      </div>
      <hr />
      <details>
        <summary>raw</summary>
        <pre>${JSON.stringify(rec, null, 2)}</pre>
      </details>
    `

    console.log($mainContainer.querySelectorAll('.instructions p'))
    $mainContainer.querySelectorAll('.instructions p').forEach(el => {
      el.addEventListener('click', function (e) {
        e.stopPropagation()
        if (e.target === e.currentTarget) e.target.classList.toggle('selected')
      })
    })
    $mainContainer.querySelectorAll('.instructions li').forEach(el => {
      el.addEventListener('click', function (e) {
        e.stopPropagation()
        if (e.target === e.currentTarget) e.target.classList.toggle('selected')
      })
    })
  }
  function renderNotFound() {
    $mainContainer.innerHTML = `
      <div>Not Found</div>
      <div>Try searching for ${window.location.hash.replace(/^#/, '')}</div>
    `
  }
}
</script>
<a href="https://github.com/paganwinter/recipe-book" style="font-size: 12px;">Repo</a><br />
<a href="https://paganwinter.github.io/recipe-book/recipes.json" style="font-size: 10px;">refresh data</a>
</body>
</html>
