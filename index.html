<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Recipes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- <script src="https://cdn.jsdelivr.net/npm/marked@16.4.1/lib/marked.umd.min.js"></script> -->
<script src="js/marked-16.4.1-marked.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css?family=Fira+Sans:400,400i,700,700i,900" rel="stylesheet">

<style>
:root {
  font-family: 'Fira Sans', sans-serif;
}
body {
  background: #f8f8f8;
}
a {
  color: #06c;
}
h4 {
  margin: 15px 0;
}

.recipe h2 {
  text-transform: uppercase;
}
.recipe code {
  font-size: 14px;
  background: #e8e8e8;
  border-radius: 3px;
  padding: 0px 5px;
  margin: 0 5px;
}
.recipe blockquote {
  border-left: 3px solid #ccc;
  margin-left: 10px;
  padding-left: 10px;
}

.category {
  /* padding: 5px; */
  /* margin: 5px; */
}
.category.active {
  background: #444;
  color: #fff;
}
.category.active a {
  background: #444;
  color: #fff;
}

.tag {
  padding: 2px 8px;
  margin: 0 3px;
  background: #e8e8e8;
  border-radius: 5px;
  display: inline-block;
  font-size: 14px;
}
.tag.active {
  background: #444;
  color: #fff;
}
.tag.active a {
  background: #444;
  color: #fff;
}

#filter-search {
  padding: 5px;
  border-radius: 5px;
  border: 1px solid #ddd;
}
</style>
</head>

<body>
<div id="root">
  <input type="search" id="filter-search" placeholder="Search...">
  <select id="filter-category">
    <option value="">-</option>
  </select>
  <a href="#">clear</a>
  <div id="filter-tags">
    <!-- <label><input type="checkbox" value="tag-1">tag-1</label> -->
  </div>
  <div id="main"></div>
  <div id="recipes-list"></div>
  <div id="recipe-details"></div>
</div>


<script>
window.onload = async function () {
  console.log(window)
  const $searchInput = document.getElementById('filter-search')
  const $categorySelect = document.getElementById('filter-category')
  const $tagsContainer = document.getElementById('filter-tags')
  const $tagCheckboxes = []
  // const $recipesList = document.getElementById('recipes-list')
  // const $recipeDetails = document.getElementById('recipe-details')
  const $mainContainer = document.getElementById('main')

  const recipes = await fetch('recipes.json').then((res) => res.json())
  console.log('recipes:', recipes)
  const categories = [...new Set(recipes.map(rec => rec.category))]
  console.log('categories:', categories)
  const tags = [...new Set(recipes.flatMap(rec => rec.tags))]
  console.log('tags:', tags)


  categories.forEach(cat => {
    $categorySelect.add(new Option(cat, cat))
  })
  tags.forEach(tag => {
    const tagId = `tag_${tag.replaceAll('-', '_')}`
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = tagId; // Unique ID for each checkbox
    checkbox.name = 'tags'; // Common name for grouping
    checkbox.value = tag;
    $tagCheckboxes.push(checkbox);

    const label = document.createElement('label');
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(tag));

    $tagsContainer.appendChild(label);
  });

  [$categorySelect, ...$tagCheckboxes].forEach(el => el.addEventListener('input', updateUrlFiltersParams));
  // when search is empty (useful for when search is cleared)
  $searchInput.addEventListener('input', () => {
    if ($searchInput.value === '') updateUrlFiltersParams()
  })
  // when enter pressed in search box (to prevent too many updates while typing)
  $searchInput.addEventListener('keydown', () => {
    if (event.key === 'Enter') updateUrlFiltersParams()
  })
  function updateUrlFiltersParams() {
    const q = $searchInput.value.toLowerCase();
    const category = $categorySelect.value;
    const tags = Array.from($tagCheckboxes)
      .filter(c => c.checked)
      .map(c => c.value);
    console.log('update url filter to :', {q, category, tags})

    const filterQueryString = new URLSearchParams()
    if (q) filterQueryString.append('q', q)
    if (category) filterQueryString.append('category', category)
    if (tags.length) filterQueryString.append('tags', tags.join(','))
    console.log('filterQueryString:', filterQueryString)
    window.location.hash = `#/?${filterQueryString}`
  }


  window.addEventListener('hashchange', handleHashChange);
  handleHashChange();
  function handleHashChange() {
    // parse hash url
    const hash = window.location.hash.replace(/^#/, '');
    const urlParts = new URL(hash, 'https://example.com')
    // console.log('route:', urlParts)
    console.log('route:', urlParts.pathname + urlParts.search)

    if (urlParts.pathname === '/') {
      // set filter params from url
      $searchInput.value = urlParts.searchParams.get('q') ?? ''
      $categorySelect.value = urlParts.searchParams.get('category') ?? ''
      const queryTags = (urlParts.searchParams.get('tags') ?? '').split(',')
      $tagCheckboxes.forEach(tagCheckbox => {
        tagCheckbox.checked = queryTags.includes(tagCheckbox.value)
      })
      filterRecipes()
    } else if (urlParts.pathname.match(/^\/recipes\/(.+)$/)) {
      const [, recipeId] = urlParts.pathname.match(/^\/recipes\/(.+)$/)
      renderRecipe(recipeId)
    } else {
      renderNotFound()
    }
  }


  function filterRecipes() {
    const q = $searchInput.value.toLowerCase();
    const category = $categorySelect.value;
    const tags = $tagCheckboxes
      .filter(c => c.checked)
      .map(c => c.value);
    console.log('filter:', {q, category, tags})

    const searchTokens = q
      ? q.match(/"([^"]*)"|'([^']*)'|(\S+)/g).map(tok => tok.replaceAll('"', '').replaceAll('\'', ''))
      : []
    const filtered = recipes.filter(rec => {
      // if (q && !rec.contentRaw.toLowerCase().includes(q)) return false
      if (searchTokens.length && !searchTokens.every(tok => rec.contentRaw.toLowerCase().includes(tok))) return false
      if (category && rec.category !== category) return false
      if (tags.length > 0 && !tags.every(t => rec.tags.includes(t))) return false
      return true
    });
    console.log('filtered:', filtered)
    renderRecipes(filtered)
  }
  function renderRecipes(recipes) {
    // $recipeDetails.style.display = 'none'
    // $recipesList.style.display = 'block'
    $mainContainer.innerHTML = recipes.map(rec => {
      const recipeId = rec.file.replace(/\.md$/, '')
      return `
        <div class="recipe-summary">
          <h4><a href="#/recipes/${recipeId}">${rec.name}</a></h4>
          <span class="category">${rec.category}</span>
          <span>${rec.tags?.map(tag => `<span class="tag">${tag}</span>`).join('')}</span>
        </div>
      `
    }).join('')
  }
  async function renderRecipe(recipeId) {
    marked.use({
      async: false,
      pedantic: false,
      gfm: true,
      // 'marked-gfm-heading-id': true,
    })

    const rec = recipes.find(rec => rec.file.replace(/\.md$/, '') === recipeId)
    if (!rec) {
      console.log(`recipe ${recipeId} not found`)
      renderNotFound()
      return
    }

    console.log('displaying recipe', rec)
    // $recipesList.style.display = 'none'
    // $recipeDetails.style.display = 'block'
    $mainContainer.innerHTML = `
      <!-- <h4>${rec.name}</h4> -->
      <span class="category">${rec.category}</span>
      <span>${rec.tags?.map(tag => `<span class="tag">${tag}</span>`).join('')}</span>
      <div class="recipe">${marked.parse(rec.recipeMd)}</div>
      <details>
        <summary>raw</summary>
        <pre>${rec.contentRaw}</pre>
      </details>
    `
  }
  function renderNotFound() {
    $mainContainer.innerHTML = `
      <div>Not Found</div>
      <div>Try searching for ${window.location.hash.replace(/^#/, '')}</div>
    `
  }
}
</script>
</body>
</html>
